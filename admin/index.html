<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>인간실험 관리자</title>
    <link rel="stylesheet" href="css/admin.css">
</head>
<body>
    <!-- 로그인 화면 -->
    <div class="admin-login-screen" id="loginScreen">
        <div class="login-box">
            <h1 class="login-title">인간실험 관리자</h1>
            <p class="login-desc">관리자 페이지 로그인</p>
            <form class="login-form" id="loginForm" onsubmit="return handleLogin(event)">
                <input type="password" id="adminPassword" class="login-input" placeholder="관리자 비밀번호" autocomplete="current-password" required>
                <button type="submit" class="login-btn">로그인</button>
            </form>
            <p class="login-hint" id="loginHint"></p>
        </div>
    </div>

    <!-- 메인 관리자 영역 -->
    <div class="admin-main hidden" id="adminMain">
        <header class="admin-header">
            <h1 class="admin-header-title">인간실험 관리자</h1>
            <div class="admin-header-actions">
                <span class="admin-user" id="adminUserLabel">관리자</span>
                <button type="button" class="btn btn-outline" onclick="handleLogout()">로그아웃</button>
            </div>
        </header>

        <nav class="admin-nav">
            <button type="button" class="admin-nav-item active" data-panel="eventList" onclick="switchPanel('eventList')">이벤트 관리</button>
            <button type="button" class="admin-nav-item" data-panel="members" onclick="switchPanel('members')">회원 관리</button>
            <button type="button" class="admin-nav-item" data-panel="bannerList" onclick="switchPanel('bannerList')">배너 관리</button>
            <button type="button" class="admin-nav-item" data-panel="settings" onclick="switchPanel('settings')">설정</button>
        </nav>

        <main class="admin-content">
            <!-- 1. 이벤트 목록 -->
            <section class="admin-panel active" id="panelEventList" data-panel="eventList">
                <div class="panel-toolbar">
                    <div class="filters">
                        <label>상태</label>
                        <select id="filterStatus" onchange="refreshEventList()">
                            <option value="">전체</option>
                            <option value="draft">초안</option>
                            <option value="scheduled">예정</option>
                            <option value="live">진행 중</option>
                            <option value="ended">종료</option>
                            <option value="cancelled">취소</option>
                        </select>
                        <label>시나리오</label>
                        <input type="text" id="filterScenario" class="filter-input" placeholder="시나리오 ID로 검색" oninput="refreshEventList()">
                    </div>
                    <button type="button" class="btn btn-primary" onclick="switchPanel('eventForm'); setFormMode('add');">+ 이벤트 추가</button>
                </div>
                <div class="table-wrap">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>이벤트명</th>
                                <th>시나리오</th>
                                <th>시작 일시</th>
                                <th>종료 일시</th>
                                <th>리워드(USDT)</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="eventListBody"></tbody>
                    </table>
                </div>
                <p class="list-empty hidden" id="listEmpty">등록된 이벤트가 없습니다.</p>
            </section>

            <!-- 2. 이벤트 추가/수정 폼 -->
            <section class="admin-panel" id="panelEventForm" data-panel="eventForm">
                <h2 class="panel-title" id="formPanelTitle">이벤트 추가</h2>
                <form class="event-form" id="eventForm" onsubmit="return saveEvent(event)">
                    <input type="hidden" id="eventId" value="">
                    <div class="form-row">
                        <label for="eventTitle">이벤트명 *</label>
                        <input type="text" id="eventTitle" placeholder="이벤트 제목을 입력하세요" required>
                    </div>
                    <div class="form-row">
                        <label for="eventScenarioId">시나리오 *</label>
                        <input type="text" id="eventScenarioId" placeholder="시나리오 ID를 입력하세요" required>
                    </div>
                    <div class="form-row">
                        <label for="eventBannerImageUrl">배너 이미지 URL</label>
                        <input type="text" id="eventBannerImageUrl" placeholder="예: wedding_banner.png">
                    </div>
                    <div class="form-row">
                        <label for="eventStartAt">시작 일시 *</label>
                        <input type="datetime-local" id="eventStartAt" required>
                    </div>
                    <div class="form-row">
                        <label for="eventEndAt">종료 일시 *</label>
                        <input type="datetime-local" id="eventEndAt" required>
                    </div>
                    <div class="form-row">
                        <label for="eventRewardUsdt">리워드 (USDT) *</label>
                        <input type="number" id="eventRewardUsdt" min="0" step="1" value="50" required>
                    </div>
                    <div class="form-row">
                        <label for="eventPlayTimeMinutes">플레이 제한시간 (분) *</label>
                        <input type="number" id="eventPlayTimeMinutes" min="1" max="120" value="10" required>
                    </div>
                    <div class="form-row">
                        <label for="eventRequiredTickets">필요 티켓 *</label>
                        <input type="number" id="eventRequiredTickets" min="0" value="1" required>
                    </div>
                    <div class="form-row">
                        <label for="eventQuestionCount">문제 수 *</label>
                        <input type="number" id="eventQuestionCount" min="1" max="20" value="10" required>
                    </div>
                    <div class="form-row">
                        <label for="eventStatus">상태</label>
                        <select id="eventStatus">
                            <option value="draft">초안</option>
                            <option value="scheduled">예정</option>
                            <option value="live">진행 중</option>
                            <option value="ended">종료</option>
                            <option value="cancelled">취소</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="formSubmitBtn">저장</button>
                        <button type="button" class="btn btn-outline" onclick="switchPanel('eventList')">취소</button>
                    </div>
                </form>
            </section>

            <!-- 3. 회원 관리 -->
            <section class="admin-panel" id="panelMembers" data-panel="members">
                <h2 class="panel-title">회원 목록</h2>
                <div class="panel-toolbar">
                    <div class="filters">
                        <label>검색</label>
                        <input type="text" id="memberSearch" class="filter-input" placeholder="닉네임 또는 회원 ID" oninput="refreshMemberList()">
                    </div>
                </div>
                <div class="table-wrap">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>회원 ID</th>
                                <th>닉네임</th>
                                <th>가입일</th>
                                <th>캐시</th>
                                <th>티켓</th>
                                <th>리워드 포인트</th>
                                <th>상태</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="memberListBody"></tbody>
                    </table>
                </div>
                <p class="list-empty hidden" id="memberListEmpty">조회된 회원이 없습니다.</p>
            </section>

            <!-- 4. 배너 목록 -->
            <section class="admin-panel" id="panelBannerList" data-panel="bannerList">
                <div class="panel-toolbar">
                    <h2 class="panel-title-inline">배너 목록</h2>
                    <button type="button" class="btn btn-primary" onclick="switchPanel('bannerForm'); setBannerFormMode('add');">+ 배너 추가</button>
                </div>
                <div class="table-wrap">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>순서</th>
                                <th>이미지 미리보기</th>
                                <th>링크 유형</th>
                                <th>링크 URL</th>
                                <th>작업</th>
                            </tr>
                        </thead>
                        <tbody id="bannerListBody"></tbody>
                    </table>
                </div>
                <p class="list-empty hidden" id="bannerListEmpty">등록된 배너가 없습니다.</p>
            </section>

            <!-- 5. 배너 추가/수정 폼 -->
            <section class="admin-panel" id="panelBannerForm" data-panel="bannerForm">
                <h2 class="panel-title" id="bannerFormPanelTitle">배너 추가</h2>
                <form class="event-form" id="bannerForm" onsubmit="return saveBanner(event)">
                    <input type="hidden" id="bannerId" value="">
                    <input type="hidden" id="bannerImageData" value="">
                    <div class="form-row">
                        <label>이미지 *</label>
                        <div class="banner-upload-area">
                            <input type="file" id="bannerImageFile" accept="image/*" onchange="onBannerFileSelect(this)">
                            <div class="banner-preview" id="bannerPreview"></div>
                            <p class="form-hint">이미지를 선택하거나 아래에 URL을 입력하세요.</p>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="bannerImageUrl">또는 이미지 URL</label>
                        <input type="text" id="bannerImageUrl" placeholder="예: https://... 또는 Main_Banner_001.png">
                    </div>
                    <div class="form-row">
                        <label for="bannerLinkType">링크 유형 *</label>
                        <select id="bannerLinkType" required>
                            <option value="internal">내부 링크 (앱 내 화면)</option>
                            <option value="external">외부 링크 (URL)</option>
                            <option value="none">링크 없음</option>
                        </select>
                    </div>
                    <div class="form-row" id="bannerLinkUrlRow">
                        <label for="bannerLinkUrl">링크 URL / 화면 ID</label>
                        <input type="text" id="bannerLinkUrl" placeholder="외부: https://... / 내부: shop, ranking 등">
                    </div>
                    <div class="form-row">
                        <label for="bannerOrder">노출 순서</label>
                        <input type="number" id="bannerOrder" min="0" value="0" placeholder="작을수록 앞에 표시">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">저장</button>
                        <button type="button" class="btn btn-outline" onclick="switchPanel('bannerList')">취소</button>
                    </div>
                </form>
            </section>

            <!-- 6. 설정 -->
            <section class="admin-panel" id="panelSettings" data-panel="settings">
                <h2 class="panel-title">설정</h2>

                <div class="settings-block">
                    <h3 class="settings-block-title">푸시 알림</h3>
                    <div class="form-row">
                        <label>알림 허용 시간대 (앱에서 기본값)</label>
                        <div class="form-inline">
                            <input type="time" id="settingNotificationStart" value="09:00">
                            <span>~</span>
                            <input type="time" id="settingNotificationEnd" value="21:00">
                        </div>
                    </div>
                    <p class="form-hint">앱 설정 화면의 “이벤트 알림” 시간대 기본값입니다. 실제 발송은 서버 연동 후 적용됩니다.</p>
                    <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">알림 설정 저장</button>
                </div>

                <div class="settings-block">
                    <h3 class="settings-block-title">푸시 발송</h3>
                    <p class="form-hint">실제 발송은 Firebase Cloud Messaging(FCM) 또는 서버 연동 후 적용됩니다. Firebase Console 등 별도 관리툴 사용 시 이 기능은 생략 가능합니다.</p>
                    <div class="form-row">
                        <label for="pushTitle">제목</label>
                        <input type="text" id="pushTitle" placeholder="푸시 제목">
                    </div>
                    <div class="form-row">
                        <label for="pushBody">내용</label>
                        <textarea id="pushBody" rows="3" placeholder="푸시 내용"></textarea>
                    </div>
                    <div class="form-row">
                        <label for="pushScheduledAt">예약 일시 (선택)</label>
                        <input type="datetime-local" id="pushScheduledAt">
                        <p class="form-hint">비워두면 즉시 발송으로 등록됩니다.</p>
                    </div>
                    <div class="form-inline form-actions">
                        <button type="button" class="btn btn-primary" onclick="sendPushNow()">즉시 발송</button>
                        <button type="button" class="btn btn-outline" onclick="schedulePush()">예약 발송 등록</button>
                    </div>
                    <div class="push-scheduled-list" id="pushScheduledListWrap">
                        <h4>예약된 푸시</h4>
                        <ul id="pushScheduledList"></ul>
                    </div>
                </div>

                <div class="settings-block">
                    <h3 class="settings-block-title">이용약관</h3>
                    <div class="form-row">
                        <label for="settingTerms">내용</label>
                        <textarea id="settingTerms" rows="12" placeholder="이용약관 내용을 입력하세요"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="saveTerms()">이용약관 저장</button>
                </div>

                <div class="settings-block">
                    <h3 class="settings-block-title">개인정보처리방침</h3>
                    <div class="form-row">
                        <label for="settingPrivacy">내용</label>
                        <textarea id="settingPrivacy" rows="12" placeholder="개인정보처리방침 내용을 입력하세요"></textarea>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="savePrivacy()">개인정보처리방침 저장</button>
                </div>
            </section>
        </main>
    </div>

    <!-- 삭제 확인 모달 (이벤트) -->
    <div class="modal hidden" id="deleteModal">
        <div class="modal-backdrop" onclick="closeDeleteModal()"></div>
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>이벤트 삭제</h3>
            <p id="deleteModalMessage">이 이벤트를 삭제하시겠습니까?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-danger" id="deleteConfirmBtn">삭제</button>
                <button type="button" class="btn btn-outline" onclick="closeDeleteModal()">취소</button>
            </div>
        </div>
    </div>

    <!-- 회원 관리 모달 (지급/차감·블록) -->
    <div class="modal hidden" id="memberModal">
        <div class="modal-backdrop" onclick="closeMemberModal()"></div>
        <div class="modal-content modal-content-wide" onclick="event.stopPropagation()">
            <h3>회원 관리</h3>
            <p class="member-modal-info" id="memberModalInfo"></p>
            <input type="hidden" id="memberModalId" value="">
            <div class="form-row">
                <label>블록 (차단)</label>
                <label class="checkbox-label"><input type="checkbox" id="memberModalBlocked"> 차단 시 로그인·플레이 불가</label>
            </div>
            <div class="form-row">
                <label>캐시</label>
                <div class="form-inline">
                    <input type="number" id="memberModalCashDelta" placeholder="숫자 입력" value="0">
                    <button type="button" class="btn btn-outline btn-sm btn-delta" onclick="applyMemberDelta('cash', 1)">지급</button>
                    <button type="button" class="btn btn-outline btn-sm btn-delta" onclick="applyMemberDelta('cash', -1)">차감</button>
                </div>
                <p class="form-hint">현재 보유: <span id="memberModalCashCurrent">0</span></p>
            </div>
            <div class="form-row">
                <label>티켓</label>
                <div class="form-inline">
                    <input type="number" id="memberModalTicketDelta" placeholder="숫자 입력" value="0">
                    <button type="button" class="btn btn-outline btn-sm btn-delta" onclick="applyMemberDelta('tickets', 1)">지급</button>
                    <button type="button" class="btn btn-outline btn-sm btn-delta" onclick="applyMemberDelta('tickets', -1)">차감</button>
                </div>
                <p class="form-hint">현재 보유: <span id="memberModalTicketCurrent">0</span></p>
            </div>
            <div class="form-row">
                <label>리워드 포인트</label>
                <div class="form-inline">
                    <input type="number" id="memberModalRewardDelta" placeholder="숫자 입력" value="0">
                    <button type="button" class="btn btn-outline btn-sm btn-delta" onclick="applyMemberDelta('rewardPoints', 1)">지급</button>
                    <button type="button" class="btn btn-outline btn-sm btn-delta" onclick="applyMemberDelta('rewardPoints', -1)">차감</button>
                </div>
                <p class="form-hint">현재 보유: <span id="memberModalRewardCurrent">0</span></p>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-primary" onclick="applyMemberAction()">적용</button>
                <button type="button" class="btn btn-outline" onclick="closeMemberModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- 삭제 확인 모달 (배너) -->
    <div class="modal hidden" id="deleteBannerModal">
        <div class="modal-backdrop" onclick="closeDeleteBannerModal()"></div>
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>배너 삭제</h3>
            <p id="deleteBannerModalMessage">이 배너를 삭제하시겠습니까?</p>
            <div class="modal-actions">
                <button type="button" class="btn btn-danger" id="deleteBannerConfirmBtn">삭제</button>
                <button type="button" class="btn btn-outline" onclick="closeDeleteBannerModal()">취소</button>
            </div>
        </div>
    </div>

    <script src="js/admin.js"></script>
</body>
</html>
