# 서버 연동 – 이어서 할 일 (Vercel 배포 완료 후)

Vercel 배포까지 완료된 상태에서, Supabase와 LINE을 제대로 연동하려면 아래 순서로 진행하면 됩니다.

---

## 현재 상태

| 항목 | 상태 |
|------|------|
| Supabase 프로젝트 / 스키마 / RLS | ✅ 적용됨 |
| config.js, supabase-client.js, api.js | ✅ 연동됨 (getUserInfo Supabase 분기 있음) |
| index.html 스크립트 순서 | ✅ config → supabase-js → supabase-client → api |
| Vercel 배포 | ✅ 완료 |
| **LINE → Supabase 인증 (JWT)** | ❌ 미구현 |
| **앱에서 로그인 후 세션 설정** | ❌ 미구현 |
| api.js 나머지 메서드 Supabase 분기 | ❌ 목업만 사용 중 |

RLS 정책이 `auth.jwt()->>'sub' = line_user_id` 이므로, **JWT를 발급·설정하기 전에는** Supabase에서 프로필 조회가 되지 않습니다.  
그래서 **가장 먼저** LINE 인증 → JWT 발급 → 세션 설정을 구현해야 합니다.

---

## 1. LINE → Supabase 인증 (우선 진행)

### 1-1. Edge Function `line-auth` 만들기

- **역할**: LIFF 액세스 토큰을 받아 LINE API로 검증 → `userId` 확보 → `profiles` 조회/생성 → **JWT 발급** (sub = line_user_id) → 클라이언트에 반환.
- **위치**: `supabase/functions/line-auth/index.ts` (또는 `.js`)  
  (가이드에는 `supabase/functions/line-auth/` 참고라고 되어 있으나, 아직 코드는 없음.)
- **필요한 것**:
  - LINE Channel Access Token (서버에서 토큰 검증용) 또는 LINE Login verify API 호출.
  - Supabase JWT Secret으로 서명한 JWT 생성 (payload에 `sub: line_user_id`).
  - CORS 설정 (LIFF 도메인 / Vercel 배포 URL 허용).

### 1-2. 앱에서 로그인 직후 세션 설정

- **위치**: LIFF 초기화가 끝난 직후 (예: `liff-auth.js`에서 `liffProfile` 설정한 뒤, 또는 `app.js` 초기화 흐름).
- **흐름**:
  1. `liff.getAccessToken()`으로 LIFF 액세스 토큰 획득.
  2. Edge Function `line-auth`에 토큰 전달 (POST).
  3. 응답으로 받은 `access_token`, `refresh_token`(선택)으로 `setSupabaseSession(accessToken, refreshToken)` 호출.
- 이렇게 하면 이후 모든 Supabase 요청에 JWT가 붙고, RLS로 `line_user_id` 기준 접근 가능해짐.

### 1-3. 정리

- **먼저 할 일**: Edge Function `line-auth` 구현 → Supabase에 배포.
- **그다음**: 앱(LIFF 초기화 직후)에서 `line-auth` 호출 → `setSupabaseSession` 호출.
- 이게 되면 현재 `api.js`의 `getUserInfo()` Supabase 분기가 실제로 프로필을 가져올 수 있습니다.

---

## 2. 그 다음에 할 수 있는 것

- **api.js 나머지 메서드 Supabase 분기**  
  - `getScenarios` → `events` + `event_questions` 조회  
  - `startGame` → `games` insert, `profiles` 티켓 감소  
  - `submitAnswer` → `game_answers` insert  
  - `completeGame` / `getEventResult` → `games` update 및 결과 조회  
  - 패턴은 기존 가이드 4.4와 동일: `if (useSupabase()) { ... sb.from(...) ... }` 후 실패 시 목업.
- **관리자**: 지금처럼 localStorage/목업 유지. 나중에 관리자 전용 API(서버에서 service_role)로 옮기는 것은 별도 작업.

---

## 3. 작업 순서 요약

1. **Edge Function `line-auth`** 구현 및 Supabase에 배포.  
2. **앱**에서 LIFF 초기화 직후 `line-auth` 호출 → `setSupabaseSession` 호출.  
3. Vercel 배포 URL에서 로그인 → 프로필이 Supabase에서 조회되는지 확인.  
4. (선택) `getScenarios`, `startGame`, `submitAnswer`, `completeGame`, `getEventResult` 등에 Supabase 분기 추가.

이 순서대로 하면 “서버 연동”을 이어서 진행할 수 있습니다.
